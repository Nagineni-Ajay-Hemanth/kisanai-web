<!-- Fertilizer recomending interface -->

<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Kisan AI - Fertilizer</title>
    <link rel="stylesheet" href="../shared/style.css">
    <script src="../shared/api-client.js"></script>
    <script src="../shared/translations.js"></script>
    <script src="../shared/language-manager.js"></script>
    <script src="../shared/notification-manager.js"></script>
</head>

<body>
    <header>
        <div class="header-brand">
            <a href="../index.html" style="display: flex; align-items: center; gap: 12px;">
                <img src="../shared/assets/icon.png" alt="FarmX logo">
                <h3>Kisan AI</h3>
            </a>
        </div>
        <nav class="header-nav">
            <button class="nav-icon-btn" onclick="window.history.back()"><span
                    style="font-size: 1.2rem;">‚¨ÖÔ∏è</span></button>
        </nav>
    </header>

    <div class="container">
        <section class="greetings-section">
            <h1 class="greetings-title" data-i18n="fertilizer_title">Fertilizer Calculator</h1>
            <p class="greetings-subtitle" data-i18n="fertilizer_subtitle">Get personalized fertilizer recommendations
                for your
                soil.</p>

            <!-- Tabs -->
            <div class="tabs" style="display: flex; gap: 10px; margin-bottom: 20px; justify-content: center;">
                <button class="tab-btn active" onclick="switchTab('scan')"
                    style="padding: 10px 20px; border-radius: 20px; border: none; background: #2ecc71; color: white;"
                    data-i18n="scan_soil">Scan
                    Soil</button>
                <button class="tab-btn" onclick="switchTab('manual')"
                    style="padding: 10px 20px; border-radius: 20px; border: none; background: #eee; color: #333;"
                    data-i18n="manual_input">Manual
                    Input</button>
            </div>

            <div class="fertilizer-form">

                <!-- Scan Section -->
                <div id="scanSection">
                    <div class="scan-container" onclick="triggerUpload()"
                        style="cursor: pointer; overflow: hidden; margin-bottom: 15px;">
                        <div class="scan-content" id="previewPlaceholder">
                            <span class="scan-icon">üå±</span>
                            <span class="scan-text" data-i18n="tap_scan">Tap to Scan Soil</span>
                        </div>
                        <img id="imagePreview"
                            style="display: none; width: 100%; height: 100%; object-fit: cover; border-radius: 12px;" />
                    </div>
                    <p id="detectedSoil"
                        style="text-align: center; color: #2ecc71; font-weight: bold; margin-bottom: 15px;"></p>
                    <div style="display: flex; gap: 10px; justify-content: center; margin-bottom: 15px;">
                        <button class="btn-camera" onclick="triggerCamera()" style="width: auto; padding: 10px 15px;"
                            data-i18n="open_camera">Camera</button>
                        <button class="btn-upload" onclick="triggerUpload()" style="width: auto; padding: 10px 15px;"
                            data-i18n="upload_image">Upload</button>
                    </div>
                    <!-- Hidden Inputs -->
                    <input type="file" id="fileInput" accept="image/*" style="display: none;"
                        onchange="handleFileSelect(event)">
                    <input type="file" id="cameraInput" accept="image/*" capture="environment" style="display: none;"
                        onchange="handleFileSelect(event)">
                </div>

                <!-- Manual Section -->
                <div id="manualSection" style="display: none;">
                    <label class="form-label" data-i18n="select_soil">Select Soil Type</label>
                    <select class="form-select" id="manualSoilSelect">
                        <option value="Clay">Clay</option>
                        <option value="Sandy">Sandy</option>
                        <option value="Loam">Loam</option>
                        <option value="Black">Black</option>
                        <option value="Red">Red</option>
                    </select>
                </div>

                <label class="form-label" data-i18n="select_crop">Select Crop</label>
                <select class="form-select" id="cropSelect">
                    <option value="Wheat">Wheat</option>
                    <option value="Rice">Rice</option>
                    <option value="Corn">Corn</option>
                    <option value="Potato">Potato</option>
                </select>

                <label class="form-label" data-i18n="land_size">Land Size (Acres)</label>
                <input type="number" placeholder="e.g. 5" class="form-input">

                <button class="btn-calculate" onclick="getRecommendation()" data-i18n="calculate">Calculate
                    Recommendation</button>
                <p id="loadingStatus" style="display:none; text-align: center; margin-top: 10px; color: #666;"
                    data-i18n="analyzing">Processing...
                </p>
            </div>

            <div class="rec-section" id="recommendations" style="display: none; margin-top: 20px;">
                <h3>Recommended Fertilizers</h3>
                <div id="recList">
                    <!-- Recommendations will be injected here -->
                </div>
            </div>
        </section>
    </div>

    <script>
        // API_BASE is handled by api-client.js now
        let currentSoilType = null;

        function switchTab(mode) {
            // ... (Tab logic remains same, removed for brevity in this replace block if not changing) ...
            const scanBtn = document.querySelector('.tab-btn:nth-child(1)');
            const manualBtn = document.querySelector('.tab-btn:nth-child(2)');
            const scanSection = document.getElementById('scanSection');
            const manualSection = document.getElementById('manualSection');

            if (mode === 'scan') {
                scanSection.style.display = 'block';
                manualSection.style.display = 'none';
                scanBtn.style.background = '#2ecc71';
                scanBtn.style.color = 'white';
                manualBtn.style.background = '#eee';
                manualBtn.style.color = '#333';
            } else {
                scanSection.style.display = 'none';
                manualSection.style.display = 'block';
                scanBtn.style.background = '#eee';
                scanBtn.style.color = '#333';
                manualBtn.style.background = '#2ecc71';
                manualBtn.style.color = 'white';
                currentSoilType = null; // Reset scanned soil type
            }
        }

        function triggerUpload() { document.getElementById('fileInput').click(); }
        function triggerCamera() { document.getElementById('cameraInput').click(); }

        async function handleFileSelect(event) {
            const file = event.target.files[0];
            if (!file) return;

            // Preview
            const reader = new FileReader();
            reader.onload = function (e) {
                document.getElementById('previewPlaceholder').style.display = 'none';
                const imagePreview = document.getElementById('imagePreview');
                imagePreview.src = e.target.result;
                imagePreview.style.display = 'block';
            }
            reader.readAsDataURL(file);

            // Upload and Detect Soil
            const loading = document.getElementById('loadingStatus');
            loading.style.display = 'block';
            loading.innerText = "Analyzing Soil...";

            // Use generic user ID for now or fetch from session if available
            // Note: prediction endpoints require user_id
            const user = SessionManager.getUser();
            const userId = user ? user.id : 1;

            try {
                // Use API Client
                const data = await KisanAIApi.predictSoil(file, userId);

                if (data.soil_type) {
                    currentSoilType = data.soil_type;
                    document.getElementById('detectedSoil').innerText = `Detected: ${data.soil_type} (${(data.confidence * 100).toFixed(1)}%)`;
                } else {
                    alert("Could not detect soil type.");
                }
            } catch (e) {
                console.error(e);
                alert("Error connecting to backend: " + e.message);
            } finally {
                loading.style.display = 'none';
            }
        }

        async function getRecommendation() {
            const crop = document.getElementById('cropSelect').value;
            // Use scanned soil if available, otherwise manual
            const soil = currentSoilType || document.getElementById('manualSoilSelect').value;

            if (!soil) {
                alert("Please scan soil or select a soil type.");
                return;
            }

            const loading = document.getElementById('loadingStatus');
            loading.style.display = 'block';
            loading.innerText = "Getting Recommendations...";

            try {
                // Use API Client
                const data = await KisanAIApi.recommendFertilizer(crop, soil);
                displayRecommendations(data.recommendations);
            } catch (e) {
                console.error(e);
                alert("Error fetching recommendations: " + e.message);
            } finally {
                loading.style.display = 'none';
            }
        }

        function displayRecommendations(recs) {
            const container = document.getElementById('recList');
            container.innerHTML = "";

            recs.forEach(rec => {
                const card = document.createElement('div');
                card.className = 'rec-card';
                card.innerHTML = `
                    <div class="rec-icon" style="background:#e8f5e9; color:#2ecc71; width: 40px; height: 40px; border-radius:50%; display:flex; align-items:center; justify-content:center; font-weight:bold;">${rec.name[0]}</div>
                    <div style="margin-left: 15px;">
                        <h5 class="rec-title" style="margin:0; font-size: 1.1em;">${rec.name}</h5>
                        <p class="rec-desc" style="margin:5px 0 0 0; color:#666; font-size: 0.9em;">${rec.desc}</p>
                    </div>
                `;
                container.appendChild(card);
            });

            document.getElementById('recommendations').style.display = 'block';
        }
    </script>


</body>

</html>