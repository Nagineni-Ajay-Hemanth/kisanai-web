<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Upload Product - Kisan AI</title>
    <link rel="stylesheet" href="../shared/style.css">
    <script src="../shared/api-client.js"></script>
</head>

<body>
    <header>
        <div class="header-brand">
            <img src="../shared/assets/icon.png" alt="Kisan AI">
            <h3>Upload Product</h3>
        </div>
        <nav class="header-nav">
            <button class="nav-icon-btn" onclick="window.location.href='../index.html'">
                <span style="font-size: 1.2rem;">⬅️</span>
            </button>
        </nav>
    </header>

    <style>
        body {
            background-color: var(--bg-body);
        }

        .auth-card {
            background: white;
            border-radius: var(--radius-lg);
            padding: 40px;
            box-shadow: var(--shadow-lg);
            border: 1px solid rgba(0, 0, 0, 0.02);
            animation: slideUp 0.6s cubic-bezier(0.165, 0.84, 0.44, 1);
        }

        .form-group {
            margin-bottom: 24px;
        }

        .form-label {
            font-weight: 700;
            color: var(--text-main);
            margin-bottom: 10px;
            display: block;
            font-size: 0.95rem;
        }

        .form-input {
            padding: 14px 20px;
            border-radius: var(--radius-sm);
            border: 1px solid rgba(0, 0, 0, 0.08);
            background: #fafafa;
            transition: var(--transition-smooth);
            font-size: 1rem;
        }

        .form-input:focus {
            background: white;
            border-color: var(--primary-light);
            box-shadow: 0 0 0 4px rgba(46, 125, 50, 0.1);
            outline: none;
        }

        #submitBtn {
            margin-top: 16px;
            padding: 18px;
            font-size: 1.1rem;
            letter-spacing: 0.5px;
            box-shadow: 0 8px 20px rgba(46, 125, 50, 0.2);
        }

        .image-preview {
            width: 100%;
            height: 200px;
            border-radius: var(--radius-md);
            background: #f8f9f8;
            border: 2px dashed rgba(0, 0, 0, 0.06);
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 24px;
            overflow: hidden;
            position: relative;
        }

        .image-preview img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }

        h2 {
            font-family: var(--font-heading);
            font-weight: 800;
        }
    </style>

    <div class="container">
        <div class="auth-card" style="max-width: 600px; margin: 20px auto;">
            <h2 id="formTitle" style="color: var(--primary); margin-bottom: 20px;">Add New Product</h2>

            <form id="productForm">
                <div class="form-group">
                    <label class="form-label">Product Name *</label>
                    <input type="text" id="productName" class="form-input" placeholder="e.g., Organic Tomatoes"
                        required>
                </div>

                <div class="form-group">
                    <label class="form-label">Category *</label>
                    <select id="productCategory" class="form-input" required>
                        <option value="">Select a category</option>
                        <option value="Vegetables">Vegetables</option>
                        <option value="Fruits">Fruits</option>
                        <option value="Grains">Grains</option>
                        <option value="Dairy">Dairy</option>
                        <option value="Spices">Spices</option>
                        <option value="Other">Other</option>
                    </select>
                </div>

                <div class="form-group">
                    <label class="form-label">Price (₹) *</label>
                    <input type="number" id="productPrice" class="form-input" placeholder="e.g., 50" step="0.01"
                        min="0.01" required>
                    <small style="color: var(--text-secondary); font-size: 0.85rem;">Enter price per unit</small>
                </div>

                <div class="form-group">
                    <label class="form-label">Unit *</label>
                    <select id="productUnit" class="form-input" required>
                        <option value="kg">Kilogram (kg)</option>
                        <option value="g">Gram (g)</option>
                        <option value="piece">Piece</option>
                        <option value="dozen">Dozen</option>
                        <option value="liter">Liter</option>
                        <option value="quintal">Quintal</option>
                        <option value="ton">Ton</option>
                    </select>
                </div>

                <div class="form-group">
                    <label class="form-label">Quantity Available *</label>
                    <input type="number" id="productQuantity" class="form-input" placeholder="e.g., 100" step="0.1"
                        min="0.1" required>
                    <small style="color: var(--text-secondary); font-size: 0.85rem;">How much do you have to
                        sell?</small>
                </div>

                <div class="form-group">
                    <label class="form-label">Description</label>
                    <textarea id="productDescription" class="form-input" rows="3"
                        placeholder="Describe your product... (e.g., Fresh, organic, pesticide-free)"></textarea>
                </div>

                <div class="form-group">
                    <label class="form-label">Image URL (optional)</label>
                    <input type="url" id="productImage" class="form-input" placeholder="https://example.com/image.jpg">
                    <small style="color: var(--text-secondary); font-size: 0.85rem;">Paste a link to your product
                        image</small>
                </div>

                <button type="submit" class="btn-primary" id="submitBtn">Upload Product</button>
                <p id="errorMsg" style="color: #d32f2f; margin-top: 15px; display: none;"></p>
                <p id="successMsg" style="color: #4CAF50; margin-top: 15px; display: none;"></p>
            </form>
        </div>
    </div>

    <script>
        SessionManager.requireAuth();
        const user = SessionManager.getUser();

        // Redirect if not farmer
        // Redirect if not farmer
        if (user.user_type !== 'farmer') {
            // Instead of redirecting, showing a modal or alert would be better
            // But for now, let's allow them to see the page but disable submission
            // Or better: Redirect to a "Become a Farmer" interim page?
            // User request was simple "where is sell", so finding it is step 1.

            // Let's just alert and redirect for now, but slightly softer
            if (confirm("You need to be registered as a Farmer to sell products. Switch to Farmer mode?")) {
                // Determine logic to switch or just let them know
                user.user_type = 'farmer';
                SessionManager.saveUser(user);
                location.reload();
            } else {
                window.location.href = '../index.html';
            }
        }

        // Check for edit mode
        const urlParams = new URLSearchParams(window.location.search);
        const editProductId = urlParams.get('id');
        let currentProduct = null;

        if (editProductId) {
            document.getElementById('formTitle').textContent = 'Edit Product';
            document.getElementById('submitBtn').textContent = 'Update Product';
            loadProductForEdit(editProductId);
        }

        async function loadProductForEdit(id) {
            try {
                const data = await KisanAIApi.getProduct(id);
                currentProduct = data.product;

                // Fill form
                document.getElementById('productName').value = currentProduct.name;
                document.getElementById('productCategory').value = currentProduct.category || '';
                document.getElementById('productPrice').value = currentProduct.price;
                document.getElementById('productUnit').value = currentProduct.unit;
                document.getElementById('productQuantity').value = currentProduct.quantity_available;
                document.getElementById('productDescription').value = currentProduct.description || '';
                document.getElementById('productImage').value = currentProduct.image_url || '';

                if (currentProduct.image_url) {
                    updateImagePreview(currentProduct.image_url);
                }
            } catch (error) {
                console.error('Error loading product for edit:', error);
                alert('Failed to load product details');
            }
        }

        // Image Preview Logic
        document.getElementById('productImage').addEventListener('input', (e) => {
            updateImagePreview(e.target.value);
        });

        function updateImagePreview(url) {
            const preview = document.getElementById('imagePreview');
            if (url) {
                preview.innerHTML = `<img src="${url}" alt="Preview" onerror="this.src='../shared/assets/icon.png'">`;
            } else {
                preview.innerHTML = `<span style="color: #999;">Image Preview</span>`;
            }
        }

        document.getElementById('productForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const submitBtn = document.getElementById('submitBtn');
            const errorMsg = document.getElementById('errorMsg');
            const successMsg = document.getElementById('successMsg');

            errorMsg.style.display = 'none';
            successMsg.style.display = 'none';

            const price = parseFloat(document.getElementById('productPrice').value);
            const quantity = parseFloat(document.getElementById('productQuantity').value);
            const category = document.getElementById('productCategory').value;
            const name = document.getElementById('productName').value.trim();

            // Validation
            if (!name) {
                errorMsg.textContent = "Please enter a product name.";
                errorMsg.style.display = 'block';
                return;
            }

            if (!category) {
                errorMsg.textContent = "Please select a category.";
                errorMsg.style.display = 'block';
                return;
            }

            if (isNaN(price) || price <= 0) {
                errorMsg.textContent = "Please enter a valid price greater than 0.";
                errorMsg.style.display = 'block';
                return;
            }

            if (isNaN(quantity) || quantity <= 0) {
                errorMsg.textContent = "Please enter a valid quantity greater than 0.";
                errorMsg.style.display = 'block';
                return;
            }

            const productData = {
                name: name,
                category: category,
                price: price,
                unit: document.getElementById('productUnit').value,
                quantity_available: quantity,
                description: document.getElementById('productDescription').value.trim() || "",
                image_url: document.getElementById('productImage').value.trim() || null
            };

            try {
                submitBtn.disabled = true;
                submitBtn.textContent = editProductId ? 'Updating...' : 'Uploading...';

                let response;
                if (editProductId) {
                    response = await KisanAIApi.updateProduct(editProductId, productData, user.id);
                } else {
                    response = await KisanAIApi.createProduct(productData, user.id);
                }

                successMsg.textContent = editProductId ? 'Product updated successfully!' : 'Product uploaded successfully!';
                successMsg.style.display = 'block';

                // Redirect after success
                setTimeout(() => {
                    window.location.href = 'my-products.html';
                }, 1500);

            } catch (error) {
                errorMsg.textContent = error.message || 'Action failed';
                errorMsg.style.display = 'block';
                submitBtn.disabled = false;
                submitBtn.textContent = editProductId ? 'Update Product' : 'Upload Product';
            }
        });
    </script>
</body>

</html>